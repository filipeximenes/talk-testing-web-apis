<!doctype html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

        <title>Testing your web API</title>

        <link rel="stylesheet" href="css/reveal.css">
        <link rel="stylesheet" href="assets/custom.css">

        <!-- Theme used for syntax highlighting of code -->
        <link rel="stylesheet" href="lib/css/zenburn.css">

        <!-- Printing and PDF exports -->
        <script>
            var link = document.createElement( 'link' );
            link.rel = 'stylesheet';
            link.type = 'text/css';
            link.href = window.location.search.match( /print-pdf/gi ) ? 'css/print/pdf.css' : 'css/print/paper.css';
            document.getElementsByTagName( 'head' )[0].appendChild( link );
        </script>
    </head>
    <body>
        <div class="reveal">
            <div class="slides">
<section>
    <h1>Testing your<br>web API</h1>
    <h2>Filipe Ximenes (@xima)</h2>
</section>

<section>
    <h3>Environment</h3>
    <ul>
        <li>Python 3</li>
        <li>Django 1.9</li>
        <li>Django REST Framework 3.3</li>
    </ul>
</section>

<section>
    <h3>App structure</h3>
    <pre><code data-trim>
.
└── app
    ├── endpoints.py
    ├── endpoints_urls.py
    ├── serializers.py
    ├── views.py
    ├── urls.py
    ├── tests
    |   ├── test_serializers.py
    |   ├── test_endpoints.py
    |   └── __init__.py
    └── __init__.py
    </code></pre>
</section>

<!-- TDD -->
<section class="section-slide">
    <h2>TDD approach</h2>
</section>
<section>
    <h3>TDD approach</h3>
    <blockquote cite="https://www.techopedia.com/definition/25850/test-driven-development-tdd">
        &ldquo;Test driven development (TDD) is an software development approach in which a test is written before writing the code. Once the new code passes the test, it is refactored to an acceptable standard.&rdquo;
    </blockquote>
</section>
<section>
    <h3>TDD approach</h3>
    <ul>
        <li>Write a failing test</li>
        <li>Make the test pass</li>
        <li>Refactor</li>
        <li>Loop back</li>
    </ul>
</section>
<section>
    <h3>TDD approach</h3>
    <ul>
        <li>No interface to click through*</li>
        <li>Refreshing is boring</li>
        <li>Use tests to guide development</li>
        <br>
        <br>
        <br>
        <br>
        <br>
        <small><p>*unless you are using DRF's browsable API</p></small>
    </ul>
</section>
<!-- /TDD -->

<!-- TestCase -->
<div class="comment">
<section class="section-slide">
    <h2>Test framework</h2>
    <h3>Python TestCase</h3>
</section>
</div>
<!-- /TestCase -->

<!-- Mocking -->
<div class="comment">
<section class="section-slide">
    <h2>Mocking</h2>
</section>
<section>
    <h3>Introduction to mocking</h3>
</section>
</div>
<!-- /Mocking -->

<!-- Unit testing -->
<section class="section-slide">
    <h2>Unit testing</h2>
    <h3>Endpoints</h3>
</section>

<section>
    <h3>Endpoints <div class="status-red"></div></h3>
    <p>Connecting endpoint to URL</p>
    <pre><code data-trim>
# test_endpoints.py

from django.core.urlresolvers import resolve
from rest_framework.test import APITestCase
from bikes.endpoints import BikeListView

class BikeListTest(APITestCase):

    def test_bike_list_url(self):
        resolver = resolve('/api/bikes/')
        self.assertEqual(resolver.func.__name__, BikeListView.__name__)
    </code></pre>
    <pre><code>ImportError: cannot import name 'BikeListView'</code></pre>
</section>

<section>
    <h3>Endpoints <div class="status-red"></div></h3>
    <pre><code data-trim>
# endpoints.py

from restframework.generics import ListAPIView

class BikeListView(ListAPIView):
    pass
    </code></pre>
    <pre><code data-trim>django.core.urlresolvers.Resolver404: {'path': 'api/bikes/', ...</code></pre>
</section>

<section>
    <h3>Endpoints <div class="status-green"></div></h3>
    <pre><code data-trim>
# urls.py

from django.conf.urls import url, include
from django.contrib import admin

urlpatterns = [
    url(r'^admin/', admin.site.urls),
    url(r'^api/', include('bikes.endpoints_urls')),
]
    </code></pre>
    <pre><code>django.core.exceptions.ImproperlyConfigured: The included URLconf ...</code></pre>

    <pre><code data-trim>
# endpoints_urls.py

from django.conf.urls import url
from bikes.endpoints import BikeListView

urlpatterns = [
    url(r'^bikes/', BikeListView.as_view()),
]
    </code></pre>
</section>

<section>
    <h3>Endpoints <div class="status-green"></h3>
    <p>Refactoring: `self.view_class`</p>
    <pre><code data-trim>
# test_endpoints.py

class BikeListTest(APITestCase):
    view_class = BikeListView

    def test_bike_list_url(self):
        resolver = resolve('/api/bikes/')
        self.assertEqual(resolver.func.__name__, self.view_class.__name__)
    </code></pre>
</section>

<section>
    <h3>Endpoints <div class="status-red"></h3>
    <p>Test url name</p>
    <pre><code data-trim>
# test_endpoints.py

    def test_bike_list_url_name(self):
        resolver = resolve('/api/bikes/')
        self.assertEqual(resolver.url_name, 'bikes-list')
    </code></pre>
    <pre><code>AssertionError: None != 'bikes-list'</code></pre>
</section>

<section>
    <h3>Endpoints <div class="status-green"></div></h3>
    <pre><code data-trim>
# endpoints_urls.py

from django.conf.urls import url
from bikes.endpoints import BikeListView

urlpatterns = [
    url(r'^bikes/', BikeListView.as_view(), name='bikes-list'),
]
    </code></pre>
</section>

<section>
    <h3>Endpoints <div class="status-green"></div></h3>
    <p>Refactoring: `self.view_name`</p>
    <pre><code data-trim>
# test_endpoints.py

class BikeListTest(APITestCase):
    view_class = BikeListView
    view_name = 'bikes-list'

    ...

    def test_bike_list_url_name(self):
        resolver = resolve('/api/bikes/')
        self.assertEqual(resolver.url_name, self.view_name)
    </code></pre>
</section>

<section>
    <h3>Endpoints <div class="status-red"></div></h3>
    <p>Test view uses `BikeSerializer`</p>
    <pre><code data-trim>
# test_endpoints.py

from bikes.serializers import BikeSerializer

    def test_bike_list_uses_bike_serializer(self):
        self.assertEqual(self.view_class().get_serializer_class(),
            BikeSerializer)
    </code></pre>
    <pre><code>ImportError: cannot import name 'BikeListView'</code></pre>
</section>

<section>
    <h3>Endpoints <div class="status-red"></div></h3>
    <pre><code data-trim>
# serializers.py

from rest_framework import serializers

class BikeSerializer(serializers.ModelSerializer):
    pass
    </code></pre>
    <pre><code>AssertionError: 'BikeListView' should either include a `serializer_class`...</code></pre>
</section>

<section>
    <h3>Endpoints <div class="status-green"></div></h3>
    <pre><code data-trim>
# endpoints.py

from bikes.serializers import BikeSerializer

class BikeListView(ListAPIView):
    serializer_class = BikeSerializer
    </code></pre>
</section>

<section>
    <h3>Model</h3>
    <pre><code>
# models.py

from django.db import models

class Bike(models.Model):
    color = models.CharField(max_length=255, null=True, blank=True)
    last_used = models.DateTimeField(null=True, blank=True)
    </code></pre>
</section>

<section>
    <h3>Serializers <div class="status-red"></div></h3>
    <p>Test we know what fields to expect</p>
    <pre><code data-trim>
# test_serializers.py

from rest_framework.test import APITestCase
from bikes.models import Bike
from bikes.serializers import BikeSerializer

class BikeSerializerTests(APITestCase):

    def test_serializer_contains_expected_fields(self):
        bike = Bike.objects.create(color='Yellow')
        serializer = BikeSerializer(instance=bike)

        data = serializer.data

        self.assertIn('color', data)
        self.assertNotIn('last_used', data)
    </code></pre>
    <pre><code>AssertionError: Class BikeSerializer missing "Meta" attribute</code></pre>
</section>

<section>
    <h3>Serializers <div class="status-red"></div></h3>
    <pre><code data-trim>
# serializers.py

from rest_framework import serializers
from bikes.models import Bike

class BikeSerializer(serializers.ModelSerializer):
    class Meta:
        model = Bike
    </code></pre>
    <pre><code>AssertionError: 'last_used' unexpectedly found in {'last_used': None...</code></pre>
</section>

<section>
    <h3>Serializers <div class="status-green"></div></h3>
    <pre><code data-trim>
# serializers.py

class BikeSerializer(serializers.ModelSerializer):
    class Meta:
        model = Bike
        fields = ['color']
    </code></pre>
</section>

<section>
    <h3>Serializers <div class="status-green"></div></h3>
    <p>Test color returns the correct value</p>
    <pre><code data-trim>
# test_serializers.py

    def test_serializer_color_field_content(self):
        bike = Bike.objects.create(color='Yellow')
        serializer = BikeSerializer(instance=bike)

        data = serializer.data

        self.assertEqual(data, {'color': 'Yellow'})
    </code></pre>
</section>

<section class="section-slide">
    <h2>DANGER</h2>
    <div class="status-red"></div>
    <div class="status-red"></div>
    <div class="status-red"></div>
    <div class="status-red"></div>
    <div class="status-red"></div>
    <div class="status-red"></div>
    <div class="status-red"></div>
    <h3>All tests MUST fail before passing</h3>
</section>

<section>
    <h3>Serializers <div class="status-red"></div></h3>
    <p>Force it to break to make sure it's beeing ran</p>
    <pre><code data-trim>
# test_serializers.py

    def test_serializer_color_field_content(self):
        bike = Bike.objects.create(color='')
        serializer = BikeSerializer(instance=bike)

        data = serializer.data

        self.assertEqual(data, {'color': 'Yellow'})
    </code></pre>
    <pre><code>AssertionError: '' != 'Yellow'</code></pre>
</section>

<section>
    <h3>Serializers <div class="status-green"></div></h3>
    <p>Refactor: use variables to avoid mistakes</p>
    <pre><code data-trim>
# test_serializers.py

    def test_serializer_color_field_content(self):
        color = 'Yellow'

        bike = Bike.objects.create(color=color)
        serializer = BikeSerializer(instance=bike)

        data = serializer.data

        self.assertEqual(data, {'color': 'Yellow'})
    </code></pre>
</section>

<section>
    <h3>Serializers <div class="status-green"></div></h3>
    <p>Refactor: use `setUp` to keep DRY</p>
    <pre><code data-trim>
# test_serializers.py

class BikeSerializerTests(APITestCase):

    def setUp(self):
        self.bike_attributes = {
            'color': 'Yellow' }

        self.bike = Bike.objects.create(**self.bike_attributes)
        self.serializer = BikeSerializer(instance=self.bike)
    </code></pre>
</section>

<section>
    <h3>Serializers <div class="status-green"></div></h3>
    <pre><code data-trim>
# test_serializers.py

    def test_serializer_contains_expected_fields(self):
        data = self.serializer.data

        self.assertIn('color', data)
        self.assertNotIn('last_used', data)

    def test_serializer_color_field_content(self):
        data = self.serializer.data

        self.assertEqual(data, {'color': 'Yellow'})
    </code></pre>
</section>

<section>
    <h3>Serializers <div class="status-red"></div></h3>
    <p>New field, test size is a float</p>
    <pre><code data-trim>
# test_serializers.py

    def test_serializer_size_field_content(self):
        data = self.serializer.data

        self.assertIsInstance(data['size'], float)
    </code></pre>
    <pre><code>KeyError: 'size'</code></pre>
</section>

<section>
    <h3>Serializers <div class="status-red"></div></h3>
    <pre><code data-trim>
# models.py

    size = models.DecimalField(max_digits=4, decimal_places=2,
        null=True, blank=True)
    </code></pre>
    <pre><code>
# serializers.py

        fields = ['color', 'size']
    </code></pre>
    <pre><code>AssertionError: {'color': 'Yellow', 'size': '52.00'} != {'color': 'Yellow'}</code></pre>
    <pre><code>AssertionError: '52.00' is not an instance of 'float'</code></pre>
</section>

<section>
    <h3>Serializers <div class="status-red"></div></h3>
    <p>Test field by field, never the full dictionary</p>
    <pre><code>
# test_serializers.py

    def test_serializer_model_name_field_content(self):
        data = self.serializer.data

        self.assertEqual(data['color'], self.bike_attributes['color'])
    </code></pre>
    <pre><code>AssertionError: '52.00' is not an instance of 'float'</code></pre>
</section>

<section>
    <h3>Serializers <div class="status-green"></div></h3>
    <pre><code data-trim>
# serializers.py

from rest_framework import serializers
from bikes.models import Bike

class BikeSerializer(serializers.ModelSerializer):
    size = serializers.FloatField()

    class Meta:
        model = Bike
        fields = ['color', 'size']
    </code></pre>
</section>

<section class="section-slide">
    <h2>DANGER</h2>
    <div class="status-red"></div>
    <div class="status-red"></div>
    <div class="status-red"></div>
    <div class="status-red"></div>
    <div class="status-red"></div>
    <div class="status-red"></div>
    <div class="status-red"></div>
    <h3>`test_serializer_contains_expected_fields` it's supposed to be failing now</h3>
</section>

<section>
    <h3>Serializers <div class="status-green"></div></h3>
    <p>Test did not capture we added new field</p>
    <pre><code>
# test_serializers.py

    def test_serializer_contains_expected_fields(self):
        data = self.serializer.data

        self.assertIn('color', data)
        self.assertNotIn('last_used', data)
    </code></pre>
</section>

<section>
    <h3>Serializers <div class="status-red"></div></h3>
    <pre><code>
# test_serializers.py

    def test_serializer_contains_expected_fields(self):
        data = self.serializer.data

        self.assertEqual(set(data.keys()), set(['color']))
    </code></pre>
</section>

<section>
    <h3>Serializers <div class="status-green"></div></h3>
    <pre><code>
# test_serializers.py

    def test_serializer_contains_expected_fields(self):
        data = self.serializer.data

        self.assertEqual(set(data.keys()), set(['color', 'size']))
    </code></pre>
</section>

<!-- /Unit testing -->


<!-- Templates -->
<div class="comment">
<section>
    <h3></h3>
    <p></p>
    <pre><code data-trim>

    </code></pre>
</section>
</div>
<!-- /Templates -->
            </div>
        </div>

        <script src="lib/js/head.min.js"></script>
        <script src="js/reveal.js"></script>

        <script>
            // More info https://github.com/hakimel/reveal.js#configuration
            Reveal.initialize({
                history: true,
                center: false,
                progress: false,
                controls: false,

                // More info https://github.com/hakimel/reveal.js#dependencies
                dependencies: [
                    { src: 'plugin/markdown/marked.js' },
                    { src: 'plugin/markdown/markdown.js' },
                    { src: 'plugin/notes/notes.js', async: true },
                    { src: 'plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } }
                ]
            });
        </script>
    </body>
</html>
